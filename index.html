<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Nguyễn Phạm Hoàng Tuấn - Thứ Năm - Ca 2</h1>

    Thi cuối kỳ


    <?php
session_start();

// Kiểm tra đăng nhập
if (!isset($_SESSION['user_logged_in'])) {
    header('Location: login.php');
    exit;
}
$currentUser = $_SESSION['username'];

// Khởi tạo session cho đơn hàng nếu chưa có
if (!isset($_SESSION['orders'])) {
    $_SESSION['orders'] = [];
}

// Include the data file
include 'data.php';

// Lấy giá trị tìm kiếm
$search_name = isset($_GET['name']) ? trim($_GET['name']) : '';
$search_type = isset($_GET['type']) ? trim($_GET['type']) : '';
$search_price = isset($_GET['price']) ? trim($_GET['price']) : '';
$search_status = isset($_GET['status']) ? trim($_GET['status']) : 'all'; // Default to 'all'

// Lọc danh sách phòng
$filtered_rooms = $rooms;
if (!empty($search_name)) {
    $filtered_rooms = array_filter($filtered_rooms, function($room) use ($search_name) {
        return stripos($room['name'], $search_name) !== false;
    });
}
if (!empty($search_type)) {
    $filtered_rooms = array_filter($filtered_rooms, function($room) use ($search_type) {
        return stripos($room['type'], $search_type) !== false;
    });
}
if (!empty($search_price)) {
    $filtered_rooms = array_filter($filtered_rooms, function($room) use ($search_price) {
        return $room['price'] <= (int)$search_price;
    });
}


// Cập nhật trạng thái phòng dựa trên session và lọc theo trạng thái tìm kiếm
if (!empty($filtered_rooms)) {
    foreach ($filtered_rooms as &$room) { // Dùng tham chiếu `&` để thay đổi trực tiếp mảng
        // Kiểm tra nếu có đơn hàng cho phòng này và giỏ hàng không rỗng
        if (isset($_SESSION['orders'][$room['id']]) && !empty($_SESSION['orders'][$room['id']]['cart'])) {
            $room['status'] = 'occupied';
            if (!isset($_SESSION['orders'][$room['id']]['start_time'])) {
                $_SESSION['orders'][$room['id']]['start_time'] = time();
            }
        } else {
            $room['status'] = 'empty';
        }
    }
    unset($room); // Hủy tham chiếu sau khi vòng lặp kết thúc

    // Lọc theo trạng thái đã chọn từ form tìm kiếm
    if ($search_status !== 'all') {
        $filtered_rooms = array_filter($filtered_rooms, function($room) use ($search_status) {
            return $room['status'] === $search_status;
        });
    }
}


// Lấy thông báo từ session nếu có
$message = null;
if (isset($_SESSION['message'])) {
    $message = $_SESSION['message'];
    unset($_SESSION['message']); // Xóa thông báo sau khi lấy
}

?>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh sách phòng - POS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Roboto', sans-serif; margin: 0; }
        
        /* HEADER */
        .header { background: #fff; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header-title { color: #007bff; font-weight: bold; font-size: 20px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 35px; height: 35px; background: #00aefd; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* MAIN CONTENT */
        .container { padding: 20px; }
        .toolbar { background: #fff; padding: 15px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border: 1px solid #e0e0e0; }
        
        /* Search Toolbar */
        .search-toolbar { background: #fff; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #e0e0e0; }
        .search-toolbar form { display: flex; align-items: center; gap: 15px; }
        .search-toolbar input[type="text"], .search-toolbar input[type="number"] { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .search-toolbar button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .search-toolbar .search-btn { background: #007bff; color: white; }
        .search-toolbar .reset-btn { background: #6c757d; color: white; }

        /* GRID PHÒNG */
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        
        .room-card {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none; /* Bỏ gạch chân link */
            color: #333;
        }
        .room-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* TRẠNG THÁI: TRỐNG (Màu xanh) */
        .room-card.empty { border: 1px solid #69f0ae; }
        .room-card.empty .icon-status { color: #69f0ae; }
        .room-card.empty .room-name { color: #2e7d32; }
        .room-card.empty .badge { background: #69f0ae; color: #fff; }

        /* TRẠNG THÁI: CÓ KHÁCH (Màu đỏ) */
        .room-card.occupied { border: 1px solid #ff8a80; }
        .room-card.occupied .icon-status { color: #ff5252; }
        .room-card.occupied .room-name { color: #d32f2f; }
        .room-card.occupied .badge { background: #ff5252; color: #fff; }

        /* Icon to ở giữa */
        .icon-status { font-size: 40px; margin-bottom: 10px; }
        .room-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .room-type { font-size: 13px; color: #666; display: flex; align-items: center; gap: 5px; }
        .room-price { font-size: 14px; color: #007bff; font-weight: 500; margin-top: 5px; }
        .room-timer { font-size: 14px; color: #333; font-weight: 500; margin-top: 10px; }

        /* Badge góc phải */
        .badge { position: absolute; top: 10px; right: 10px; font-size: 11px; padding: 3px 8px; border-radius: 10px; font-weight: bold; }
        
        .delete-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            line-height: 25px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .room-card:hover .delete-btn {
            opacity: 1;
        }

        /* FOOTER CHÚ THÍCH */
        .legend { margin-top: 30px; display: flex; gap: 20px; font-size: 14px; background: #fff; padding: 15px; border-radius: 5px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        /* Modal styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 30px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 450px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slide-down 0.3s ease-out;
        }
        @keyframes slide-down {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .modal form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        .modal form input[type="text"], .modal form input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Important */
            margin-bottom: 15px;
        }
        .modal form input[type="submit"] {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        .modal form input[type="submit"]:hover {
            background-color: #218838;
        }

        /* Notification Message */
        .notification {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #fff;
            position: relative;
            opacity: 1;
            transition: opacity 0.5s;
        }
        .notification.success { background-color: #28a745; }
        .notification.error { background-color: #dc3545; }
        .notification .close-notif {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="header-title"><i class="fa fa-th-large"></i> Chọn Phòng</div>
        <div class="user-info">
            <span><?= htmlspecialchars($currentUser) ?></span>
            <div class="avatar" title="<?= htmlspecialchars($currentUser) ?>"><?= strtoupper(substr($currentUser, 0, 1)) ?></div>
            <a href="logout.php" style="color: #d32f2f; font-size: 1.2em;" title="Đăng xuất"><i class="fa fa-sign-out-alt"></i></a>
        </div>
    </div>

    <div class="container">
        <?php if ($message): ?>
            <div id="notification-banner" class="notification <?= $message['type'] ?>">
                <span class="close-notif" onclick="this.parentElement.style.display='none';">&times;</span>
                <?= htmlspecialchars($message['text']) ?>
            </div>
        <?php endif; ?>

        <div class="toolbar">
            <div style="font-weight: bold;"><i class="fa fa-th"></i> Danh sách phòng</div>
            <div>
                <button id="addRoomBtn" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 14px; font-weight: 500; display: inline-block; vertical-align: middle;">
                    <i class="fa fa-plus"></i> Thêm phòng
                </button>
                <a href="statistics.php" style="background: #ffc107; color: #212529; text-decoration: none; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 14px; font-weight: 500; display: inline-block; vertical-align: middle;">
                    <i class="fa fa-chart-bar"></i> Thống kê
                </a>
                <a href="menu.php" style="background: #17a2b8; color: white; text-decoration: none; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 14px; font-weight: 500; display: inline-block; vertical-align: middle;">
                    <i class="fa fa-utensils"></i> Quản lý Menu
                </a>
                <button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; vertical-align: middle;">
                    <i class="fa fa-sync"></i> Làm mới
                </button>
            </div>
        </div>

        <!-- Search Form -->
        <div class="search-toolbar">
            <form action="room.php" method="GET">
                <input type="text" name="name" placeholder="Tên phòng..." value="<?= htmlspecialchars($search_name) ?>">
                <input type="text" name="type" placeholder="Loại phòng..." value="<?= htmlspecialchars($search_type) ?>">
                <input type="number" name="price" placeholder="Giá tối đa..." value="<?= htmlspecialchars($search_price) ?>">
                <select name="status">
                    <option value="all" <?= $search_status == 'all' ? 'selected' : '' ?>>Tất cả trạng thái</option>
                    <option value="empty" <?= $search_status == 'empty' ? 'selected' : '' ?>>Trống</option>
                    <option value="occupied" <?= $search_status == 'occupied' ? 'selected' : '' ?>>Có khách</option>
                </select>
                <button type="submit" class="search-btn"><i class="fa fa-search"></i> Tìm kiếm</button>
                <a href="room.php" class="reset-btn" style="text-decoration: none; padding: 8px 15px;">Làm mới</a>
            </form>
        </div>


        <div class="room-grid">
            <?php if (!empty($filtered_rooms)): foreach ($filtered_rooms as $room): ?>
                <?php 
                    // Xác định class CSS dựa trên trạng thái
                    $statusClass = ($room['status'] == 'occupied') ? 'occupied' : 'empty';
                    $statusText  = ($room['status'] == 'occupied') ? 'Có khách' : 'Trống';
                    $iconClass   = ($room['status'] == 'occupied') ? 'fa-users' : 'fa-check-circle';
                    $startTime = isset($_SESSION['orders'][$room['id']]['start_time']) ? $_SESSION['orders'][$room['id']]['start_time'] : 0;
                    $endTime = isset($_SESSION['orders'][$room['id']]['end_time']) ? $_SESSION['orders'][$room['id']['end_time']] : 0;
                ?>
                
                <div class="room-card <?= $statusClass ?>" 
                    data-start-time="<?= $startTime > 0 ? $startTime : '' ?>"
                    data-end-time="<?= $endTime > 0 ? $endTime : '' ?>">
                    <a href="delete_room.php?id=<?= $room['id'] ?>" class="delete-btn" onclick="return confirm('Bạn có chắc chắn muốn xóa phòng này không?');" title="Xóa phòng"><i class="fa fa-trash"></i></a>
                    <a href="index.php?room_id=<?= $room['id'] ?>&room_name=<?= urlencode($room['name']) ?>&room_type=<?= $room['type'] ?>&price=<?= $room['price'] ?>" style="text-decoration: none; color: inherit; display: flex; flex-direction: column; align-items: center; width: 100%;">
                        <span class="badge"><?= $statusText ?></span>
                        <i class="fa <?= $iconClass ?> icon-status"></i>
                        <div class="room-name"><?= $room['name'] ?></div>
                        <div class="room-type"><i class="fa fa-home"></i> <?= $room['type'] ?></div>
                        <div class="room-price"><i class="fa fa-tag"></i> <?= number_format($room['price']) ?> VND/giờ</div>
                        <?php if ($statusClass == 'occupied'): ?>
                            <div class="room-timer" id="timer-<?= $room['id'] ?>"></div>
                        <?php endif; ?>
                    </a>
                </div>

            <?php endforeach; else: ?>
                <p>Không tìm thấy phòng nào phù hợp.</p>
            <?php endif; ?>
        </div>

        <div class="legend">
            <div>Chú thích trạng thái:</div>
            <div><span class="dot" style="background: #69f0ae;"></span>Trống</div>
            <div><span class="dot" style="background: #ff5252;"></span>Có khách</div>
        </div>
    </div>
    
    <!-- The Modal -->
    <div id="addRoomModal" class="modal">
      <!-- Modal content -->
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2><i class="fa fa-plus-circle"></i> Thêm phòng mới</h2>
        <form action="add_room.php" method="post">
            <label for="name">Tên phòng:</label>
            <input type="text" id="name" name="name" placeholder="Ví dụ: Phòng 101" required>
            <label for="type">Loại phòng:</label>
            <input type="text" id="type" name="type" placeholder="Ví dụ: VIP, Thường" required>
            <label for="price">Giá (VND/giờ):</label>
            <input type="number" id="price" name="price" placeholder="Ví dụ: 100000" required min="0">
            <input type="submit" value="Thêm phòng">
        </form>
      </div>
    </div>

<script>
    function updateTimers() {
        const roomCards = document.querySelectorAll('.room-card.occupied');
        roomCards.forEach(card => {
            const startTime = parseInt(card.getAttribute('data-start-time'), 10);
            const endTime = parseInt(card.getAttribute('data-end-time'), 10);
            
            if (isNaN(startTime) || startTime === 0) return;

            let now;
            if (isNaN(endTime) || endTime === 0) { // If timer is still running
                now = Math.floor(Date.now() / 1000);
            } else { // If timer has been stopped
                now = endTime;
            }
            
            const elapsedTime = now - startTime;

            const hours = Math.floor(elapsedTime / 3600);
            const minutes = Math.floor((elapsedTime % 3600) / 60);
            const seconds = elapsedTime % 60;

            const timerElement = card.querySelector('.room-timer');
            if (timerElement) {
                timerElement.innerHTML = `<i class="fa fa-clock"></i> ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        });
    }

    setInterval(updateTimers, 1000);
    document.addEventListener('DOMContentLoaded', function() {
        updateTimers();

        // Auto-hide notification
        const notification = document.getElementById('notification-banner');
        if (notification) {
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.style.display = 'none', 500);
            }, 5000); // Hide after 5 seconds
        }

        // Modal script
        var modal = document.getElementById("addRoomModal");
        var btn = document.getElementById("addRoomBtn");
        var span = document.getElementsByClassName("close")[0];

        btn.onclick = function() {
          modal.style.display = "block";
        }
        span.onclick = function() {
          modal.style.display = "none";
        }
        window.onclick = function(event) {
          if (event.target == modal) {
            modal.style.display = "none";
          }
        }
    });
</script>

</body>
</html>